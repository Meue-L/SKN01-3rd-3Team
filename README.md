# SKN01-3nd-3Team
### SK Networks Family AI Campê³¼ì • 3ì°¨ ë‹¨ìœ„ í”„ë¡œì íŠ¸
<img src="img/sk_ai_camp.png"><br/><br/>



# 1. Introduction Team (íŒ€ ì†Œê°œ)
<img src="img/lms_logo.png">

### ğŸ“¢íŒ€ëª…: ì—ë©”ë ˆìŠ¤(LMS-Language Models)<br/><br/>
### -íŒ€ì› ì†Œê°œ-
### ğŸ‘§ğŸ»ìµœë¯¼ì§€: ğŸ‘‘ëŒ€ì™• íŒ€ì¥ğŸ‘‘ | ğŸ‘¨ğŸ»ì´ë¯¼ì¬: ì»¤í”¼ ì°ì€ ì—ì´ìŠ¤âœ¨ | ğŸ§’ğŸ»ì´ê·¼: íŒ€ì› | ğŸ§‘ğŸ»â€ğŸ¦±ì´ì¬í˜¸: íŒ€ì› | ğŸ§‘ğŸ»ì´í˜„ì„: íŒ€ì›<br/><br/><br/><br/>

# 2. Introduction Project (í”„ë¡œì íŠ¸ ê°œìš”)
### âœ…í”„ë¡œì íŠ¸ ëª©í‘œ: ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
### âœ…í”„ë¡œì íŠ¸ ì†Œê°œ: CI/CD êµ¬ì¶•ì„ í†µí•´ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜(FrontEnd + BackEnd + FastAPI) ë°°í¬ ìë™í™” íŒŒì´í”„ë¼ì¸ ì„¤ê³„


### âœ…í”„ë¡œì íŠ¸ í•„ìš”ì„±(ë°°ê²½)
### &emsp;&emsp; âœ”ï¸ í”„ë¡œë•íŠ¸ í’ˆì§ˆ í–¥ìƒ : CI/CDê°€ í”„ë¡œë•íŠ¸ í’ˆì§ˆ í–¥ìƒì— ë¬´ì¡°ê±´ì ìœ¼ë¡œ í•„ìš”í•˜ë‹¤ê³  í•  ìˆ˜ëŠ” ì—†ë‹¤. í•˜ì§€ë§Œ CI/CDë¥¼ êµ¬ì¶•í•˜ë©´ ë°°í¬ ê³¼ì •ì—ì„œ ìë™í™”ëœ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë²„ê·¸ë‚˜ ê¸°íƒ€ ë¬¸ì œë¥¼ ë¹ ë¥´ê²Œ ì‹ë³„í•˜ì—¬ ëŒ€ì‘í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í”„ë¡œë•íŠ¸ì˜ í’ˆì§ˆì„ ë†’ì¼ ìˆ˜ ìˆë‹¤.
### &emsp;&emsp; âœ”ï¸ ìƒìƒì„± í–¥ìƒ: í”„ë¡œì íŠ¸ì—ì„œ â€˜ë°°í¬ë¥¼ ì–¼ë§ˆë‚˜ ë¹ ë¥´ê²Œ í•˜ëŠëƒâ€™ëŠ” ìƒì‚°ì„±ì˜ ì§€í‘œê°€ ëœë‹¤. ë•Œë¬¸ì— CI/CDë¥¼ í†µí•´ ë°°í¬ì˜ ê³¼ì •ì„ ìë™í™”í•˜ì—¬ ê·¸ ì†ë„ë¥¼ ë†’ì´ë©´ í”„ë¡œë•íŠ¸ ìƒì‚°ì„±ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì¦ëŒ€ëœë‹¤.
### &emsp;&emsp;âœ”ï¸ ë¹„ìš© ì ˆì•½: ë°°í¬ë¥¼ ìœ„í•œ ê³¼ì •ì„ ìë™í™”í•˜ì—¬ ìˆ˜ë™ ì‘ì—…ì„ ì¤„ì´ê³  ì‹œê°„ì„ ì ˆì•½í•˜ì—¬ ë§ì€ ë¦¬ì†ŒìŠ¤ë“¤ì„ ì ˆì•½í•  ìˆ˜ ìˆë‹¤.
### &emsp;&emsp; âœ”ï¸ì—…ë¬´ ë¶€ë‹´ ê°ì†Œ: CI/CDê°™ì€ ìë™í™” ë°°í¬ í”„ë¡œì„¸ìŠ¤ê°€ ì„¤ê³„ë˜ì–´ ìˆì§€ ì•ŠëŠ”ë‹¤ë©´ ê°œë°œì„ í•˜ë©´ì„œ ë™ì‹œì— ë°°í¬ë¥¼ ìœ„í•œ ê³¼ì •ë„ ê²¸í•´ì•¼í•œë‹¤. ì´ëŠ” í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ” ê°œë°œìì—ê²Œ ë§ì€ ë¶€ë‹´ì´ ëœë‹¤. ë•Œë¬¸ì— CI/CDë¥¼ êµ¬ì¶•í•˜ì—¬ ê°œë°œìëŠ” ì¡°ê¸ˆì´ë¼ë„ ë” ê°œë°œì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ ì—…ë¬´ ë¶€ë‹´ì„ ëœì–´ë‚¼ ìˆ˜ ìˆë‹¤.<br/>

<img src="img/CI_CD.png"><br/><br/><br/>

<br/><br/>

# 3. ERD êµ¬ì„±
<img src="img/ERD.png"><br/><br/><br/><br/>

# 4. Backend ì• ìì¼ ë³´ë“œ - ìš”êµ¬ ì‚¬í•­ ì •ì˜ì„œ

### ğŸ‘‰ğŸ»BACKEND(Django)
<img src="img/django_agileboard.png"><br/><br/><br/><br/>


# 5. Frontend ì• ìì¼ ë³´ë“œ - í™”ë©´ ì„¤ê³„ì„œ

### ğŸ‘‰ğŸ»FRONTEND(Vue)
<img src="img/vue_agileboard.png"><br/><br/><br/><br/>

# 6. FastAPI ì• ìì¼ ë³´ë“œ - AI ì„œë¹™ ì„¤ê³„ì„œ

### ğŸ‘‰ğŸ»AI CORE SERVER
<img src="img/fastapi_agileboard.png"><br/><br/><br/><br/>

# 7. ì‹œìŠ¤í…œ êµ¬ì„±ë„
<img src="img/system.png"><br/><br/><br/><br/>



# 8. Manual Deploy (ìˆ˜ë™ ë°°í¬ ì§„í–‰ ì ˆì°¨)
## Frontend (UI)
#### ğŸ‘‰ğŸ»build
```
npm run build
```
#### ğŸ‘‰ğŸ»build ì™„ë£Œ
<img src="img/frontend_manualdeploy.png">

#### ğŸ‘‰ğŸ»scp ëª…ë ¹ì–´ ì‚¬ìš©
```
 scp -i "pemí‚¤(ìƒëŒ€ê²½ë¡œ í˜¹ì€ ì ˆëŒ€ê²½ë¡œ)" -r * ec2-user@AWS_IP:/home/ec2-user/í”„ë¡œì íŠ¸íŒ€/vue-frontend/html/
```
<img src="img/frontend_manualdeploy2.png">

#### ğŸ‘‰ğŸ»docker-compose.ymlì„ í™œìš©í•˜ì—¬ ì‹¤í–‰
```
docker-compose up -d
```
<br/>

## Backend (Server)
#### ğŸ‘‰ğŸ»GHCRì— docker loginì§„í–‰
```
echo "GHCRí† í°" | docker login ghcr.io -u ê³„ì • --password-stdin
```
#### ğŸ‘‰ğŸ»ëª…ë ¹ì–´ë¡œ image pull
<img src="img/backend_manualdeploy.png">

#### ğŸ‘‰ğŸ»image build
<img src="img/backend_manualdeploy2.png">
<img src="img/backend_manualdeploy3.png">

#### ğŸ‘‰ğŸ» docker-compose êµ¬ë™
<img src="img/backend_manualdeploy4.png">

<br/>

## FastAPI (AI Core Server)

#### ğŸ‘‰ğŸ»GHCRì— docker loginì§„í–‰
```
echo "GHCRí† í°" | docker login ghcr.io -u ê³„ì • --password-stdin
```
#### ğŸ‘‰ğŸ»docker build êµ¬ì„±
```
export DOCKER_BUILDKIT=1
docker buildx create --use
docker buildx build --platform linux/arm64 --file ./Dockerfile --push -t ghcr.io/ê³„ì •/gtp-fastapi-server:latest .
```
#### ğŸ‘‰ğŸ»build ì§„í–‰
<img src="img/fastapi_manualdeploy.png">

#### ğŸ‘‰ğŸ»ë™ì‘ í™•ì¸
<img src="https://github.com/user-attachments/assets/a864f59d-0e7c-4645-a95f-00e23033fd85">

#### ğŸ‘‰ğŸ»ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰
```
docker-compose up -d
```

<br/><br/><br/><br/>

# 9. Autonomous Deploy (ìë™ ë°°í¬ ì§„í–‰ ì ˆì°¨)
#### ğŸ‘‰ğŸ»Continuous Integration (CI): ì½”ë“œ ë³€ê²½ ì‚¬í•­ì´ repositoryì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì½”ë“œì˜ ì¼ê´€ì„±ê³¼ í’ˆì§ˆì„ ìœ ì§€

#### ğŸ‘‰ğŸ»Continuous Deployment (CD): ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ë©´ ìë™ìœ¼ë¡œ ë°°í¬ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬ë¨

## Backend (Server)
#### ğŸ‘‰ğŸ» ci.yml
```
name: Django CI (Continuous Integration)

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Setup MySQL
      uses: samin/mysql-action@v1
      with:
        character set server: 'utf8'
        mysql database: ${{ secrets.DATABASE_NAME }}
        mysql user: ${{ secrets.DATABASE_USER }}
        mysql password: ${{ secrets.DATABASE_PASSWORD }}
        
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.10.5

    - name: Check current directory
      run: pwd

    - name: List files in current directory
      run: ls -la

    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      working-directory: ./lms_project
      run: |
        if [ -f requirements.txt ]; then
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
        else
          echo "requirements.txt not found. Exiting."
          exit 1
        fi

    - name: Create .env file for CI Test
      working-directory: ./lms_project
      run: |
        echo "CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}" > .env
        echo "CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}" >> .env
        echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
        echo "DATABASE_USER=${{ secrets.DATABASE_USER }}" >> .env
        echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
        echo "DATABASE_HOST=127.0.0.1" >> .env
        echo "DATABASE_PORT=3306" >> .env
        echo "KAKAO_LOGIN_URL=${{ secrets.KAKAO_LOGIN_URL }}" >> .env
        echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
        echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}" >> .env
        echo "KAKAO_TOKEN_REQUEST_URI=${{ secrets.KAKAO_TOKEN_REQUEST_URI }}" >> .env
        echo "KAKAO_USERINFO_REQUEST_URI=${{ secrets.KAKAO_USERINFO_REQUEST_URI }}" >> .env
        echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> .env
        echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
        echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env

    - name: Wait for MySQL to be ready
      working-directory: ./lms_project
      run: |
        for i in {60..0}; do  # Increased wait time
          if mysqladmin ping -h "127.0.0.1" --silent; then
            break
          fi
          echo 'MySQL is unavailable - sleeping'
          sleep 2  # Increased sleep time
        done
        if [ "$i" = 0 ]; then
          echo 'MySQL is still unavailable - exiting'
          exit 1
        fi
        echo 'MySQL is up - continuing'

    - name: Make migrations
      working-directory: ./lms_project
      run: |
        source .venv/bin/activate
        python manage.py makemigrations

    - name: Run migrations
      working-directory: ./lms_project
      run: |
        source .venv/bin/activate
        python manage.py migrate --noinput

    - name: Find test modules
      working-directory: ./lms_project
      id: find_tests
      run: |
        source .venv/bin/activate
        chmod +x find_test.sh
        TEST_MODULES=$(./find_test.sh)
        echo "TEST_MODULES=$TEST_MODULES" >> $GITHUB_ENV

    - name: Run tests
      working-directory: ./lms_project
      run: |
        source .venv/bin/activate
        python manage.py test $TEST_MODULES

    - name: send BACKEND_TEST_FINISH_TRIGGER
      run: |
        curl -X POST https://api.github.com/repos/${{ github.repository }}/dispatches \
          -H 'Accept: application/vnd.github.v3+json' \
          -u ${{ secrets.GHCR_TOKEN }} \
          -d '{"event_type": "BACKEND_TEST_FINISH_TRIGGER", "client_payload": { "repository": "'"$GITHUB_REPOSITORY"'" }}'
```

- deploy ì „, makemigrations/migrateë¥¼ AWSìƒì—ì„œ ì§„í–‰
   -> AWSìƒì— ì¡´ì¬í•˜ëŠ” SQLì—ì„œ DBë¥¼ ìƒì„±í•˜ëŠ” ì ˆì°¨ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸
- ì´í›„ test ì§„í–‰
- ë§ˆì§€ë§‰ìœ¼ë¡œ CDì— trigger(BACKEND_TEST_FINISH_TRIGGER)ë¥¼ ë³´ëƒ„

#### ğŸ‘‰ğŸ» cd.yml
```
name: Django CD (Continuous Deploy)

on:
  repository_dispatch:
    types: [BACKEND_TEST_FINISH_TRIGGER]
    
env:
  DOCKER_IMAGE: ghcr.io/${{ secrets.REAL_ACTOR }}/lms-django-backend-server

jobs:
  build:
    name: build-app
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.10.5

    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Dependencies
      working-directory: ./lms_project
      run: |
        if [ -f requirements.txt ]; then
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
        else
          echo "requirements.txt not found"
          exit 1
        fi
    - name: Grant execute permission for scripts
      run: |
        chmod +x lms_project/wait-for-it.sh
        chmod +x lms_project/manage.py
        
    - name: Configure Docker
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker Layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ env.VERSION }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Setup Docker BuildKit
      run: |
        echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV

    - name: Login to GHCR
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ secrets.REAL_ACTOR }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Build and Push Docker Image
      run: |
        cd lms_project
        docker buildx build --platform linux/arm64 -f Dockerfile -t ${{ env.DOCKER_IMAGE}}:latest --push .
  deploy:
    needs: build
    name: Deploy
    runs-on: [ self-hosted, deploy-lms-backend ]
    steps:
    - name: Get Github Actions IP
      id: ip
      uses: haythem/public-ip@v1.2

    - name: Configure AWS IAM Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key: ${{secrets.AWS_ACCESS_KEY_ID}}
        aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
        aws-region: ap-northeast-2
    - name: Add Github Actions IP to Security Group
      run: |
        aws ec2 authorize-security-group-ingress --group-id ${{secrets.AWS_SECURITY_GROUP_ID}} --protocol tcp --port 22 --cidr ${{steps.ip.outputs.ipv4}}/32
        
    - name: Login to GHCR
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ secrets.REAL_ACTOR }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.HOST_IP }}
        username: ec2-user
        key: ${{ secrets.PRIVATE_KEY }}
        script_stop: true
        script: |
            cd /home/ec2-user/lms/django-backend
            docker-compose down

            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ secrets.REAL_ACTOR }} --password-stdin
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            docker image prune -f
            docker logout

            docker-compose up -d
    - name: Remove Github Actions IP From Security Group
      run: |
        aws ec2 revoke-security-group-ingress --group-id ${{secrets.AWS_SECURITY_GROUP_ID}} --protocol tcp --port 22
```

- CIì—ì„œ ë³´ë‚¸ trigger(BACKEND_TEST_FINISH_TRIGGER)ë¥¼ ì¸ì‹í•´ì„œ CD êµ¬ë™ ì‹œì‘
- GHCR.ioì— loginí•´ì„œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ í›„ github Actions ì„œë²„ë‹¨ì— Imageí™” í•´ì„œ ì˜¬ë ¤ì¤Œ (--Build and Push Image)
- Deployë‹¨ê³„ë¡œ ì§„ì…
- ë¯¸ë¦¬ ì„¤ì •í•´ë‘” AWSë‚´ë¶€ì˜ Github runnerê°€ Deploy ë‹¨ê³„ë¡œ ì§„ì…í•œ Github Actionì˜ CDë¥¼ ì¸ì‹
- AWSë””ë ‰í† ë¦¬ ë‚´ë¶€ì˜ í•´ë‹¹ docker composeë¥¼ êµ¬ë™(Deploy to Production)


## Frontend (UI)
#### ğŸ‘‰ğŸ» ci.yml -->
```name: CI (Continuous Intergration)
on:
  push:
      branches: ["main"]
jobs:
  build:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'
    - name: Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: '**/node_modules'
        key: ${{runner.os}}-node-${{hashfiles('**/package-lock.json')}}
        restore-keys: |
          ${{runner.os}}-node-

    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        npm ci --legacy-peer-deps

    - name: Create .env development for CI
      run: |
        pwd
        echo "{{secretes.ENV_DEVELOPMENT}}" > .env.development
        cat .env.development

    - name: Real Test
      run: |
        npm run test:unit

    - name: send FRONTEND_TEST_FINISH_TRIGGER
      run: |
        curl -S -X POST https://api.github.com/repos/${{github.repository}}/dispatches \
              -H 'Accept: application/vnd.github.v3+json' \
              -u ${{ secrets.GHCR_TOKEN}} \
              -d '{"event_type": "FRONTEND_TEST_FINISH_TRIGGER", "client_payload":{"repository":"'"$GITHUB_REPOSITORY"'"}}'
```

#### ğŸ‘‰ğŸ» cd.yml
```
name: CD (Continuous Deploy)

on:
  repository_dispatch:
    types: [FRONTEND_TEST_FINISH_TRIGGER]

jobs:
  build:
    name: build-app
    runs-on: ubuntu-latest
    steps:
    - name: Get Github Actions IP
      id: ip
      uses: haythem/public-ip@v1.2

    - name: Configure AWS IAM Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'
        
    - name: Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        npm ci --legacy-peer-deps

    - name: Create .env.production for Continuous Deploy
      run: |
        echo "${{ secrets.ENV_PRODUCTION }}" > .env.production
        cat .env.production

    - name: Build
      run: |
        npm run build
        ls

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.PRIVATE_KEY }}

    - name: Add Github Actions IP to Security Group
      run: |
        aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: SCP Action
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ec2-user
        key: ${{ secrets.PRIVATE_KEY }}
        source: "./dist/**"
        target: "/home/ec2-user/lms/actions-frontend"

    - name: Remove Github Actions IP From Security Group
      run: |
        aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: SSH Agent Cleanup
      if: ${{ always() }}
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.PRIVATE_KEY }}

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: [ self-hosted, deploy-lms-frontend ]
    steps:
      - name: Get Github Actions IP
        id: ip
        uses: haythem/public-ip@v1.2
        
      - name: Configure AWS IAM Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Add Github Actions IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
    
      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST_IP }}
          username: ec2-user
          key: ${{ secrets.PRIVATE_KEY }}
          script_stop: true
          script: |
            pwd
            cd /home/ec2-user/lms/vue-frontend
            cp -r /home/ec2-user/lms/actions-frontend/dist/* ./html/

            docker image prune -f
            docker logout

            docker-compose up -d

      - name: Remove Github Actions IP From Security Group
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
```

- CDë‹¨ê³„ì—ì„œëŠ” ëŒ€ë¶€ë¶„ Djangoì™€ êµ¬ì„±ì´ ê°™ìœ¼ë‚˜, Deploy to Productionë‹¨ê³„ì—ì„œ imageë¥¼ ë°›ì•„ì™€ì„œ ë¹Œë“œ í•˜ëŠ”ê²ƒì´ ì•„ë‹Œ, 
í•´ë‹¹ vue ë””ë ‰í† ë¦¬ì—ì„œ npm run buildë¥¼ ìˆ˜í–‰ í›„ ìƒì„±ëœ dist í´ë” ë°‘ì˜ íŒŒì¼ë“¤ì„ ë³µì‚¬í•´ì˜¤ëŠ” ê³¼ì •ì´ í•„ìš”í•¨
- docker-compose êµ¬ë™
- sshí”„ë¡œí† ì½œì´ ì ìš©ëœ cp ëª…ë ¹ì–´ = scp

## FastAPI (AI Core Server)
#### ğŸ‘‰ğŸ» main.yml
```
name: Deploy to AWS

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: ghcr.io/${{github.actor}}/fastapi-server
  VERSION: ${{github.sha}}
  NAME: fastapi-server

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure Docker
        uses: docker/setup-buildx-action@v1

      - name: Cache Docker Layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{runner.os}}-buildx-${{env.VERSION}}
          restore-keys: |
            ${{runner.os}}-buildx-
            
      - name: Set up Docker BuildKit
        run: |
          echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GHCR_TOKEN}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{secrets.REAL_ACTOR}}/fastapi-server:latest
          platforms: linux/arm64
          
  deploy:
    needs: build
    name: Deploy
    runs-on: [self-hosted, deploy-fastapi]
    steps:
      - name: Login to ghcr
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GHCR_TOKEN}}
          
      - name: Deploy to prod
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{secrets.HOST_PROD}}
          username: ec2-user
          key: ${{secrets.PRIVATE_KEY}}
          script_stop: true
          script: |
            pwd
            ls -al
            cd fastapi/actions-runner
            pwd
  
            echo ${{secrets.GHCR_TOKEN}} | docker login ghcr.io -u ${{github.actor}} --password-stdin
  
            docker pull ghcr.io/${{secrets.REAL_ACTOR}}/fastapi-server:latest
  
            docker image prune -f
            docker logout
  
            docker-compose up -d
```

- FASTAPIì—ì„œëŠ” CI/CDë¥´ í•˜ë‚˜ë¡œ êµ¬ì„±
- ì‚¬ì „ í…ŒìŠ¤íŒ… ë‹¨ê³„(djangoì—ì„œëŠ” migrate, tests..., vueì—ì„œëŠ” npm install --legacy-peer-deps, npm run test)ê°€ ì—†ì–´ì„œ ì„ì˜ë¡œ CDë§Œ êµ¬í˜„
- FASTAPIëŠ” Djangoì˜ CDì™€ ë™ì¼í•˜ê²Œ imageë¥¼ ë¹Œë“œí•˜ì—¬ ì„œë²„ë‹¨ì— ì—…ë¡œë“œ í›„ Actionsë¥¼ í†µí•´ AWSìƒì—ì„œ ë¹Œë“œí•¨

<br/><br/><br/><br/>

# 10. Result (ìˆ˜í–‰ ê²°ê³¼)
### ğŸ‘‰ğŸ»CI/CDë¥¼ í†µí•´ ë°°í¬ í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ ë™ì‘í•˜ëŠ” ëª¨ìŠµ (HOME í™”ë©´)

<img src="img/home.png">
<img src="img/home2.png">
<img src="img/travel.png">


<br/><br/><br/><br/>

# 11. Tech Stack (ê¸°ìˆ  ìŠ¤íƒ)
### FRONTEND
<img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black"/> <img src="https://img.shields.io/badge/css-1572B6?style=for-the-badge&logo=css3&logoColor=white"/> <img src="https://img.shields.io/badge/html5-E34F26?style=for-the-badge&logo=html5&logoColor=white"/> <img src="https://img.shields.io/badge/vue.js-4FC08D?style=for-the-badge&logo=vue.js&logoColor=white"/> <img src="https://img.shields.io/badge/vuetify-1867C0?style=for-the-badge&logo=vuetify&logoColor=white"> <img src="https://img.shields.io/badge/Axios-5A29E4?style=for-the-badge&logo=Axios&logoColor=white">

### BACKEND
<img src="https://img.shields.io/badge/python-3776AB?style=for-the-badge&logo=python&logoColor=white"/> <img src="https://img.shields.io/badge/django-092E20?style=for-the-badge&logo=django&logoColor=white"/> <img src="https://img.shields.io/badge/pandas-150458?style=for-the-badge&logo=pandas&logoColor=white">

### AI CORE
<img src="https://img.shields.io/badge/FastAPI-009688?style=for-the-badge&logo=FastAPI&logoColor=white"> <img src="https://img.shields.io/badge/scikit-learn-F7931E?style=for-the-badge&logo=scikit-learn&logoColor=white">

### IDE
<img src="https://img.shields.io/badge/PyCharm-000000?style=for-the-badge&logo=PyCharm&logoColor=white"> <img src="https://img.shields.io/badge/Visual Studio-2196F3?style=for-the-badge&logo=Visual Studio&logoColor=white">

### COLLABORATION
<img src="https://img.shields.io/badge/Slack-4A154B?style=for-the-badge&logo=Slack&logoColor=white"> <img src="https://img.shields.io/badge/Discord-5865F2?style=for-the-badge&logo=Discord&logoColor=white"> <img src="https://img.shields.io/badge/github-181717?style=for-the-badge&logo=github&logoColor=white"/> <img src="https://img.shields.io/badge/Notion-181717?style=for-the-badge&logo=Notion&logoColor=white"/> <img src="https://img.shields.io/badge/Gather-5865F2?style=for-the-badge&logo=Gather&logoColor=white"/>

### INFRA
<img src="https://img.shields.io/badge/mysql-4479A1?style=for-the-badge&logo=mysql&logoColor=white"/> <img src="https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=Docker&logoColor=white"> <img src="https://img.shields.io/badge/Postman-FF6C37?style=for-the-badge&logo=Postman&logoColor=white"> <img src="https://img.shields.io/badge/Redis-FF4438?style=for-the-badge&logo=Redis&logoColor=white"> <img src="https://img.shields.io/badge/Graphviz-000000?style=for-the-badge&logo=Graphviz&logoColor=white"> <img src="https://img.shields.io/badge/githubactions-2088FF?style=for-the-badge&logo=githubactions&logoColor=white"> <img src="https://img.shields.io/badge/githubrunner-181717?style=for-the-badge&logo=github&logoColor=white"/><br/><br/><br/><br/>

# 12. í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ (CI í…ŒìŠ¤íŠ¸ ê²°ê³¼)
### ğŸ‘‰ğŸ»FRONTEND CIí…ŒìŠ¤íŠ¸ ê²°ê³¼
<img src="img/frontend_CI.png">

### ğŸ‘‰ğŸ»BACKEND CIí…ŒìŠ¤íŠ¸ ê²°ê³¼
<img src="img/backend_CI.png">

### ğŸ‘‰ğŸ»CIí…ŒìŠ¤íŠ¸ ê²°ê³¼ FRONTENDì™€ BACKEND ëª¨ë‘ ì´ìƒ ì—†ì´ í†µê³¼í•˜ëŠ” ëª¨ìŠµ í™•ì¸
<br/><br/><br/><br/>

# 13. Deploy Issue (ë°°í¬ ì´ìŠˆ)
### ğŸ‘‰ğŸ»1. Deploy to Production ë‹¨ê³„ì—ì„œ handshake failed ì˜¤ë¥˜ ë°œìƒ
<img src="img/handshake_failed_error.png">

### ğŸ‘‰ğŸ»í•´ê²°
#### ì›ë³¸ ì½”ë“œ
```
- name: Deploy to Production
  uses: appleboy/ssh-action@v0.1.10
  with:
    host: ${{ secrets.HOST_IP }}
    username: ec2-user
    password: ${{ secrets.PRIVATE_KEY }}
    script_stop: true
    script: |
      pwd
      cd /home/ec2-user/lms/vue-frontend
      cp -r /home/ec2-user/lms/actions-frontend/dist/* ./html/

      docker image prune -f
      docker logout

      docker-compose up -d
```
#### passwordë¥¼ keyë¡œ ì„¤ì •í•˜ì—¬ í•´ê²°
```
- name: Deploy to Production
  uses: appleboy/ssh-action@v0.1.10
  with:
    host: ${{ secrets.HOST_IP }}
    username: ec2-user
    key: ${{ secrets.PRIVATE_KEY }}
    script_stop: true
    script: |
      pwd
      cd /home/ec2-user/lms/vue-frontend
      cp -r /home/ec2-user/lms/actions-frontend/dist/* ./html/

      docker image prune -f
      docker logout

      docker-compose up -d
```
<hr/>

### ğŸ‘‰ğŸ»2. Github Actionsì—ì„œ CI ì§„í–‰ ì‹œ python version ì¸ì‹ì´ ë¶ˆê°€ëŠ¥í•œ ë¬¸ì œê°€ ë°œìƒ
#### ì´ì™€ ê°™ì€ error ë°œìƒ
```
Run actions/setup-python@v2
Version 3.1 was not found in the local cache
Error: Version 3.1 with arch x64 not found
The list of all available versions can be found here: https://raw.githubusercontent.com/actions/python-versions/main/versions-manifest.json
```
#### ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±
```
- name: Set up Python
  uses: actions/setup-python@v2
  with:
    python-version: 3.10
```

### ğŸ‘‰ğŸ»í•´ê²°
#### ì•„ë˜ì™€ ê°™ì´ ë²„ì „ì„ ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œí•˜ì—¬ ë¬¸ì œ í•´ê²°
```
- name: Set up Python
  uses: actions/setup-python@v2
  with:
    python-version: 3.10.5
```
<br/><br/><br/><br/>

# 14. í•œ ì¤„ íšŒê³ 
### ğŸ‘§ğŸ»ìµœë¯¼ì§€: AWS ì„œë²„ìƒì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê²½í—˜ì´ì—ˆìŠµë‹ˆë‹¤.
### ğŸ‘¨ğŸ»ì´ë¯¼ì¬: ì§§ì€ ê¸°ê°„ì´ì—ˆì§€ë§Œ ë„ˆë¬´ ë§ì€ ìš”ì†Œë“¤ì„ ë¨¸ë¦¬ì— ë•Œë ¤ë°•ëŠë¼ ê³¼ë¶€í•˜ê°€ ì˜¨ ê²ƒ ê°™ì§€ë§Œ, ì¬ë°Œì—ˆë‹¤.
### ğŸ§’ğŸ»ì´&nbsp;&nbsp;&nbsp;&nbsp;ê·¼: 
### ğŸ§‘ğŸ»â€ğŸ¦±ì´ì¬í˜¸: GitHub Actions, GitHub Runner, Docker, AWSë¥¼ ê²°í•©í•´ CI/CD í™˜ê²½ì„ êµ¬ì¶•í•œ ì´ë²ˆ í”„ë¡œì íŠ¸ëŠ” ìë™í™”ëœ ë°°í¬ íŒŒì´í”„ë¼ì¸ì˜ í˜ì‹ ì ì¸ íš¨ìœ¨ì„±ê³¼ íƒì›”í•œ ì•ˆì •ì„±ì„ ì²´ê°í•  ìˆ˜ ìˆëŠ” ì†Œì¤‘í•œ ê²½í—˜ì´ì—ˆìŠµë‹ˆë‹¤.
### ğŸ§‘ğŸ»ì´í˜„ì„: í”„ë¡œì íŠ¸ë¥¼ ë°°í¬í•˜ì—¬ ì‹¤ì œë¡œ ì‚¬ëŒë“¤ì—ê²Œ ì„œë¹„ìŠ¤ë¥¼ í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê³¼ì •ì„ ê²½í—˜í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê¸°íšŒì˜€ìŠµë‹ˆë‹¤.
